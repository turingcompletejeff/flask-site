{% extends "layout.html" %}
{% from "macros/fields.html" import render_text_field %}

{% block title %}New Post{% endblock %}

{% block content %}
<div class="blog-post-strip">
  <h1 class="blog-header">create new post</h1>

  <div class="blog-post">
    <form action="{{ url_for('blogpost_bp.new_post') }}" method="post" enctype="multipart/form-data">
      {{ form.hidden_tag() }}

      <div id="new-post-header">
        <div class="form__group">
          {{ form.title.label(class_="form__label") }}
          {{ form.title(class_="form__field", id="blog-title-input", placeholder="Enter post title...") }}
          {%- for error in form.title.errors %}
            <span class="form__error">{{ error }}</span>
          {% endfor %}
        </div>

        <div class="image-fields-row">
          <div class="form__group">
            {{ form.portrait.label(class_="form__label") }}
            {{ form.portrait(class_="form__field", id="blog-img-input") }}
            {%- for error in form.portrait.errors %}
              <span class="form__error">{{ error }}</span>
            {% endfor %}

            <div id="portrait-resize-controls" style="display: none; margin-top: 10px;">
              <label class="form__label">Portrait Display Options:</label>
              <div style="margin: 10px 0;">
                <label>
                  <input type="radio" name="portrait_display" value="auto" checked>
                  Auto (original size, up to 100% of its container)
                </label>
              </div>
              <div style="margin: 10px 0;">
                <label>
                  <input type="radio" name="portrait_display" value="custom">
                  Custom size
                </label>
                <div id="custom-size-controls" style="display: none; margin-left: 20px;">
                  <label>Max width:
                    <input type="range" name="portrait_max_width" min="5" max="100" value="100" step="5">
                    <span id="width-display">100</span>% of container
                  </label>
                </div>
              </div>

              <!-- Image preview that matches view_post styling -->
              <div id="image-preview" style="display: none; margin-top: 15px; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9;">
                <label class="form__label">Preview (as it will appear in view):</label>
                <img id="preview-image" class="blog-portrait" style="" />
              </div>
            </div>
          </div>

          <div class="form__group">
            {{ form.thumbnail.label(class_="form__label") }}
            {{ form.thumbnail(class_="form__field", id="blog-thumbnail-input") }}
            {%- for error in form.thumbnail.errors %}
              <span class="form__error">{{ error }}</span>
            {% endfor %}
          </div>
        </div>
      </div>

      <hr />

      <div class="form__group">
        {{ form.content.label(class_="form__label") }}
        {{ form.content(class_="form__field", id="blog-content-input", rows="10", cols="50", placeholder="write the next big thing...") }}
        {%- for error in form.content.errors %}
          <span class="form__error">{{ error }}</span>
        {% endfor %}
      </div>

      <hr />

      <div class="blog-post-actions">
        {{ form.submit(class_="submit-btn") }}
        <a href="{{ url_for('main_bp.index') }}" class="cancel-btn">cancel</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block endjs %}
<script>
$(document).ready(function() {
  const portraitInput = $('#blog-img-input');
  const resizeControls = $('#portrait-resize-controls');
  const customControls = $('#custom-size-controls');
  const widthSlider = $('input[name="portrait_max_width"]');
  const widthDisplay = $('#width-display');
  const imagePreview = $('#image-preview');
  const previewImage = $('#preview-image');

  function updatePreviewStyling() {
    const displayMode = $('input[name="portrait_display"]:checked').val();
    const maxWidth = widthSlider.val();

    // Apply the same styling logic as view_post.html
    if (displayMode === 'custom') {
      previewImage.css('width', maxWidth + '%');
    } else {
      previewImage.css('width', '');  // Remove custom width, use auto/default
    }
  }

  // Show resize controls and preview when an image is selected
  portraitInput.on('change', function() {
    if (this.files && this.files[0]) {
      resizeControls.show();

      // Show image preview
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.attr('src', e.target.result);
        imagePreview.show();
        updatePreviewStyling();
      };
      reader.readAsDataURL(this.files[0]);
    } else {
      resizeControls.hide();
      imagePreview.hide();
    }
  });

  // Toggle custom size controls and update preview
  $('input[name="portrait_display"]').on('change', function() {
    if ($(this).val() === 'custom') {
      customControls.show();
    } else {
      customControls.hide();
    }
    updatePreviewStyling();
  });

  // Update width display and preview as user moves slider
  widthSlider.on('input', function() {
    widthDisplay.text($(this).val());
    updatePreviewStyling();
  });

  // Form submission handler to include resize parameters
  $('form').on('submit', function() {
    const displayMode = $('input[name="portrait_display"]:checked').val();
    const maxWidth = widthSlider.val();

    // Add hidden fields with resize parameters
    if (displayMode === 'custom') {
      $(this).append('<input type="hidden" name="portrait_resize_params" value=\'{"display_mode": "custom", "width_pct": ' + maxWidth + '}\'>');
    } else {
      $(this).append('<input type="hidden" name="portrait_resize_params" value=\'{"display_mode": "auto"}\'>');
    }
  });
});
</script>
{% endblock %}
