{% extends "layout.html" %}

{% block title %}tv{% endblock %}

{% block js %}
  <style>
    :root { --gap: 12px; --radius: 12px; --shadow: 0 6px 20px rgba(0,0,0,.08); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#0b0d10; color:#eef2f8; }
    h1 { font-size: 20px; margin:0; font-weight:700; letter-spacing:.2px; }
    #search { flex:1; padding:12px 14px; border-radius: 10px; border:1px solid #263040; background:#121820; color:#e7edf7; }
    /* main { display:grid; grid-template-columns: 1.2fr .8fr; gap: var(--gap); padding: 16px 20px 40px; } */
    @media (max-width: 980px) { main{ grid-template-columns: 1fr; } }
    /* Player panel */
    .panel { background:#0f141b; border:1px solid #1e2734; border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden; }
    .panel h2 { font-size:16px; margin:0; padding:14px 16px; border-bottom:1px solid #1e2734; color:#b9c6d8; }
    #playerWrap { position:relative; background:#000; aspect-ratio:16/9; }
    video { width:100%; height:100%; display:block; }
    .meta { padding:12px 16px; display:flex; gap:12px; align-items:flex-start; }
    .meta img { width:64px; height:96px; object-fit:cover; border-radius:8px; border:1px solid #1e2734; }
    .meta .info { flex:1; }
    .meta .title { font-size:18px; font-weight:700; margin-bottom:4px; }
    .meta .sub { opacity:.75; font-size:13px; margin-bottom:8px; }
    .meta .desc { opacity:.85; font-size:13px; line-height:1.35; max-height: 3.9em; overflow:hidden; }
    .controls { padding: 0 16px 14px; display:flex; gap:10px; align-items:center; }
    .btn { padding:10px 12px; background:#1a2330; border:1px solid #263040; border-radius:10px; color:#e7edf7; cursor:pointer; }
    .btn:hover { background:#212c3c; }
    select { background:#121820; color:#e7edf7; border:1px solid #263040; border-radius:10px; padding:8px 10px; }
    /* Grid */
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: var(--gap); }
    .card { background:#0f141b; border:1px solid #1e2734; border-radius: var(--radius); overflow:hidden; box-shadow: var(--shadow); cursor:pointer; transition: transform .12s ease; }
    .card:hover { transform: translateY(-2px); }
    .thumb { width:100%; aspect-ratio:2/3; object-fit:cover; background:#0b0d10; display:block; }
    .label { padding:10px; font-size:14px; color:#c9d6e5; display:flex; justify-content:space-between; gap:8px; }
    .year { opacity:.65; font-size:12px; }
    .empty { padding:20px; opacity:.7; }
  </style>
  
  <!-- hls.js (needed for non-Safari browsers) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
{% endblock %}

{% block content %}

<main style="width:1080px;">
  <!-- Player / Now Playing -->
  <section class="panel" id="playerPanel">
    <h2 id="nowTitle">Nothing playing</h2>
    <div id="playerWrap">
      <video id="player" controls playsinline></video>
    </div>
    <div class="meta" id="nowMeta" style="display:none;">
      <img id="nowThumb" alt="">
      <div class="info">
        <div class="title" id="nowName"></div>
        <div class="sub" id="nowSub"></div>
        <div class="desc" id="nowDesc"></div>
      </div>
    </div>
    <div class="controls" id="subtitleBar" style="display:none;">
      <label for="subs">Subtitles:</label>
      <select id="subs"></select>
      <button class="btn" id="stopBtn">Stop</button>
    </div>
  </section>
</main>
{% endblock %}

{% block rightsidebar %}

  <!-- Library Grid -->
  <section class="panel">
    <h2>Library</h2>
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">No items match your search.</div>
  </section>

{% endblock %}

{% block endjs %}
  <script>
    // --- configuration: adjust only if you changed the Flask routes below ---
    const ITEMS_ENDPOINT = "/media/api/items";              // returns array of items
    const HLS_ENDPOINT   = (id) => `/media/api/hls/${id}`;  // returns { hls_url, subtitles: [...] }

    const state = { all: [], filtered: [] };
    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");

    const video = document.getElementById("player");
    let hls = null;
    
    
    function render(items) {
      grid.innerHTML = "";
      if (!items.length) { empty.style.display = "block"; return; }
      empty.style.display = "none";
      for (const it of items) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img class="thumb" src="${it.thumb_url}" alt="${it.name}" loading="lazy">
          <div class="label">
            <span title="${it.name}">${it.name}</span>
            <span class="year">${it.year || ""}</span>
          </div>`;
        card.onclick = () => playItem(it);
        grid.appendChild(card);
      }
    }

    function filterList(q) {
      q = (q || "").trim().toLowerCase();
      state.filtered = !q ? state.all : state.all.filter(it =>
        (it.name || "").toLowerCase().includes(q)
      );
      render(state.filtered);
    }

    async function fetchItems() {
      const res = await fetch(ITEMS_ENDPOINT, { credentials: "same-origin" });
      if (!res.ok) throw new Error("Failed to load items");
      state.all = await res.json(); // expects [{id, name, year, overview, thumb_url, runtime, type}]
      filterList("");
    }

    function setNowMeta(it) {
      document.getElementById("nowTitle").textContent = it.name || "Now Playing";
      document.getElementById("nowMeta").style.display = "flex";
      document.getElementById("nowThumb").src = it.thumb_url || "";
      document.getElementById("nowThumb").alt = it.name || "";
      document.getElementById("nowName").textContent = it.name || "";
      const mins = it.runtime ? Math.round(it.runtime / 60) : null;
      document.getElementById("nowSub").textContent = [it.type, mins ? `${mins} min` : null, it.year || null].filter(Boolean).join(" â€¢ ");
      document.getElementById("nowDesc").textContent = it.overview || "";
    }

    function clearSubs() {
      while (video.firstChild) {
        if (video.firstChild.nodeName === "TRACK") video.removeChild(video.firstChild);
        else break;
      }
    }

    function loadSubs(tracks) {
      const bar = document.getElementById("subtitleBar");
      const select = document.getElementById("subs");
      select.innerHTML = "";
      clearSubs();

      if (!tracks || !tracks.length) { bar.style.display = "none"; return; }

      // "Off" option
      const optOff = document.createElement("option");
      optOff.value = "";
      optOff.textContent = "Off";
      select.appendChild(optOff);

      tracks.forEach((t, idx) => {
        const track = document.createElement("track");
        track.kind = "subtitles";
        track.label = t.label || t.lang || `Track ${idx+1}`;
        track.srclang = t.lang || "und";
        track.src = t.url;
        track.default = false;
        video.appendChild(track);

        const opt = document.createElement("option");
        opt.value = idx.toString();
        opt.textContent = track.label;
        select.appendChild(opt);
      });

      select.onchange = () => {
        const idx = select.value ? parseInt(select.value, 10) : -1;
        for (let i = 0; i < video.textTracks.length; i++) {
          video.textTracks[i].mode = (i === idx) ? "showing" : "disabled";
        }
      };

      bar.style.display = "flex";
    }

    function stopPlayback() {
      if (hls) { hls.destroy(); hls = null; }
      video.pause();
      video.removeAttribute("src");
      clearSubs();
    }

    async function playItem(it) {
      try {
        // Ask backend for a per-user, tokenized HLS URL (and optional subtitle tracks)
        const res = await fetch(HLS_ENDPOINT(it.id), { credentials: "same-origin" });
        if (!res.ok) throw new Error("Failed to get stream URL");
        const data = await res.json(); // expects { hls_url, subtitles?: [{label, lang, url}] }

        stopPlayback();
        setNowMeta(it);
        loadSubs(data.subtitles || []);

        const hlsUrl = data.hls_url;

        if (window.Hls && Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(hlsUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = hlsUrl;
          video.addEventListener("loadedmetadata", () => video.play().catch(()=>{}), { once:true });
        } else {
          alert("HLS is not supported in this browser.");
        }
      } catch (e) {
        console.error(e);
        alert("Could not start playback.");
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("stopBtn").onclick = stopPlayback;

      fetchItems().catch(err => {
        console.error(err);
        grid.innerHTML = "";
        empty.style.display = "block";
        empty.textContent = "Failed to load library.";
      });
    });

    
  </script>
{% endblock %}
