{% extends "layout.html" %}
{% from "macros/fields.html" import render_text_field, render_textarea, render_file_field, render_coordinate_fields %}

{% block title %}Minecraft Server{% endblock %}

{% block js %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mc-status.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/mc-locations.css') }}">
{% endblock %}

{% block content %}

<!-- Minecraft Locations Section -->
<section class="minecraft-locations" id="locations-section">
    <div class="locations-header">
        <h2>Fast Travel Locations</h2>

        {% if current_user.is_authenticated and (current_user.has_role('minecrafter') or current_user.is_admin()) %}
        <button type="button" id="btn-new-location" class="clicky-primary">
            <span class="btn-icon">+</span> Add New Location
        </button>
        {% endif %}
    </div>

    <!-- Inline Create Form (Initially Hidden) -->
    {% if current_user.is_authenticated and (current_user.has_role('minecrafter') or current_user.is_admin()) %}
    <div id="new-location-form-container" class="location-form-container" style="display: none;">
        <form id="new-location-form" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div class="form-header">
                <h3>Create New Location</h3>
                <button type="button" id="btn-cancel-form" class="btn-close" aria-label="Close form">&times;</button>
            </div>

            <!-- Name Field -->
            {{ render_text_field(form.name, placeholder="e.g., Spawn, Farm, Castle") }}

            <!-- Description Field -->
            {{ render_textarea(form.description, placeholder="Optional description of this location", rows=3) }}

            <!-- Coordinates Fields (Grouped) -->
            {{ render_coordinate_fields(form.position_x, form.position_y, form.position_z) }}

            <!-- Portrait Image Field -->
            {{ render_file_field(form.portrait) }}
            <small class="field-hint">JPG or PNG screenshot of the location</small>

            <!-- Thumbnail Image Field (Optional) -->
            {{ render_file_field(form.thumbnail) }}
            <small class="field-hint">Optional: Leave empty to auto-generate from portrait</small>

            <!-- Form Error Display -->
            <div id="form-errors" class="form-errors-container" style="display: none;"></div>

            <!-- Submit Buttons -->
            <div class="form-buttons">
                <button type="submit" class="clicky-success">
                    <span class="btn-icon">âœ“</span> Create Location
                </button>
                <button type="button" id="btn-cancel-create" class="clicky-secondary">
                    Cancel
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Locations Grid -->
    <div class="locations-grid" id="locations-grid">
        <!-- Locations will load here via AJAX -->
        <p class="loading">Loading locations...</p>
    </div>
</section>

<hr />

<div id="terminal-wrapper">
	<pre id="rcon-response">&nbsp;</pre>
	<input id="mc-input" placeholder="type a command..."/>
	<button id="mc-cmd" type="button" onclick="rconCommand()">send</button>
</div>
<div class="offline-message" id="offline-message" role="alert">
  <strong>Server Offline:</strong> The Minecraft server is currently offline. Command input is disabled until the server comes back online.
</div>
<hr />
Visit
<a href="https://github.com/OwenCochell/mctools#minecraft-connection-tools">mc tools</a>
for more info
{% endblock %}

{% block rightsidebar %}
<div id="right-sidebar">
<div id="rcon-query">
  <!-- Status Indicator -->
  <div class="status-container">
    <div class="status-indicator unknown loading" id="status-indicator"
         role="status" aria-label="Server status indicator"></div>
    <div class="status-info">
      <div class="status-text" id="status-text">Checking status...</div>
      <div class="status-timestamp" id="status-timestamp"></div>
    </div>
    <button class="refresh-button" id="refresh-button"
            type="button" aria-label="Refresh server status">
      <span class="material-symbols-outlined">refresh</span>
    </button>
  </div>

  <p id="rcon-motd"></p>
  <p id="rcon-plugins"></p>
  <p id="rcon-version"></p>
  <table id="rcon-query-players">
  </table>
</div>
</div>
{% endblock %}

{% block endjs %}
<script>
  // Define API endpoints for mc-status.js and mc-locations.js
  var MC_ENDPOINTS = {
    status: "{{ url_for('mc.mc_status') }}",
    list: "{{ url_for('mc.list') }}",
    query: "{{ url_for('mc.rconQuery') }}",
    command: "{{ url_for('mc.rconCommand') }}",
    locations: "{{ url_for('mc.list_locations') }}",
    createLocation: "{{ url_for('mc.create_location_ajax') }}",
    uploadedFiles: "{{ url_for('mc.uploaded_files_dir') }}",
    editLocation: function(id) { return `/mc/locations/${id}/edit`; },
    deleteLocation: function(id) { return `/mc/locations/${id}/delete`; }
  };

  var IS_USER_MINECRAFTER = {% if current_user.is_authenticated and (current_user.has_role('minecrafter') or current_user.is_admin()) %}true{% else %}false{% endif %};
</script>
<script src="{{ url_for('static', filename='js/mc-status.js') }}"></script>
<script src="{{ url_for('static', filename='js/mc-locations.js') }}"></script>
{% endblock %}
