{% extends "layout.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}

<div class="blog-post">
    {% if current_user.is_authenticated and post.is_draft %}
    <div class="draft-banner">
        <span class="draft-banner-icon">⚠️</span>
        <span class="draft-banner-text">This post is currently a draft and not visible to other users</span>
    </div>
    {% endif %}
    <div class="blog-post-header">
    <h2>{{ post.title }}</h2>
    {% if current_user.is_authenticated %}
          <a class="blog-post-edit" href="{{ url_for('blogpost.edit_post', post_id=post.id) }}">
            <span class="material-symbols-outlined hover-edit"></span>
          </a>
          <div class="blog-post-delete" data-id="{{ post.id }}">
            <span class="material-symbols-outlined hover-delete"></span>
          </div>
    {% endif %}
    </div>
    <div>{{ post.content |safe}}</div>
    {% if post.portrait %}
    {% set portrait_style = "" %}
    {% if post.themap and post.themap.portrait_display %}
      {% if post.themap.portrait_display.display_mode == "custom" %}
        {% if post.themap.portrait_display.max_width_vw %}
          {% set portrait_style = "width: " + post.themap.portrait_display.max_width_vw|string + "vw;" %}
        {% elif post.themap.portrait_display.width_pct %}
          {% set portrait_style = "width: " + post.themap.portrait_display.width_pct|string + "%;" %}
        {% endif %}
      {% endif %}
    {% endif %}
    <img class="blog-portrait" src="{{ url_for('main.uploaded_file', filename=post.portrait) }}"
         {% if portrait_style %}style="{{ portrait_style }}"{% endif %} />
    {% endif %}
    <hr />
    <div class="blog-post-timestamps">
      <small >Posted on {{ post.date_posted.strftime('%Y-%m-%d') }}</small>
      {% if post.hasEdits() %}
      <small class="blog-post-edited">Edited on {{ post.last_updated|localtime }}</small>
      {% endif %}
    </div>
</div>

{% endblock %}
{% block endjs %}
{% if current_user.is_authenticated %}
<script>
  $(document).ready(function() {
    // delete post
    $(".blog-post-delete").on('click', function() {
      let button = $(this);
      
      if(button.hasClass("delete-confirm")) {
        // delete the post for real
        $.post("{{ url_for('blogpost.delete_post') }}", 
             { id: button.data("id") }, function() {
          
          button.parents(".blog-post").fadeOut(400,function() {
              $(this).remove();
          });
          
          window.location.href = "{{ url_for('main.index') }}?flash=post+deleted&category=success";
        }).fail(function() {
          addFlashMessage("danger","error deleting post");
        });
      } else {
        // slide out to a confirm button, avoiding accidental clicks
        button.addClass("delete-confirm");
      }

      
    });
    
  });
</script>
{% endif %}
{% endblock %}